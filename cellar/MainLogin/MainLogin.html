<html>
    <head>
        <title>20200526</title>
    </head>
    <body>
        <pe:mcml>
            <script type="text/npl">
                <![CDATA[
                    NPL.load("(gl)script/apps/Aries/Creator/Game/Login/Rebranding.lua")
                    local Config = NPL.load("(gl)Mod/CodePku/config/Config.lua")

                    Rebranding = commonlib.gettable("MyCompany.Aries.Creator.Game.Rebranding")
                    local GameMainLogin = commonlib.gettable("MyCompany.Aries.Game.MainLogin")
                    local MainLogin = NPL.load("./MainLogin.lua")                                                            
                    local CodePkuServiceSession = NPL.load("(gl)Mod/CodePku/service/CodePkuService/Session.lua")

                    local page = document:GetPageCtrl()
                    Mod.CodePku.Store:Set("page/MainLogin", page)

                    function OnOpenModulePage()
                        NPL.load("(gl)script/apps/Aries/Creator/Game/Login/SelectModulePage.lua");
                        local SelectModulePage = commonlib.gettable("MyCompany.Aries.Game.MainLogin.SelectModulePage")
                        SelectModulePage.ShowPage()
                    end

                    function OnChangeLanguagePage()
                        NPL.load("(gl)script/apps/Aries/Creator/Game/Common/Translation.lua")

                        local Translation = commonlib.gettable("MyCompany.Aries.Game.Common.Translation")
                        Translation.ShowPage(function()
                            page:Refresh(0.01)
                        end)
                    end

                    function GetModDes()
                        local modname = ParaEngine.GetAppCommandLineByParam("mod","")
                        local s = string.format(L"当前Mod:%s",modname)
                        return s
                    end

                    function OnCustomCharacter()
                    end                                        
                        
                    function GetModCountAsString()
                        NPL.load("(gl)script/apps/Aries/Creator/Game/Mod/ModManager.lua")
                        local ModManager = commonlib.gettable("Mod.ModManager")
                        local pluginloader = ModManager:GetLoader()
                        local nCount = pluginloader:GetActiveModCount()

                        if nCount > 0 then
                            return format("(%d)", nCount)
                        else
                            return ""
                        end
                    end

                    function OnClickCustomerService()
                        ParaGlobal.ShellExecute("open", L"https://keepwork.com/official/docs/FAQ/questions", "", "", 1)
                    end

                    function login_text()
                        return Mod.CodePku.Store:Get("user/loginText")
                    end

                    function get_history_users()
                        return MainLogin:GetHistoryUsers()
                    end

                    function login()
                        local agree = page:GetValue("agree")
                        local account = page:GetValue("account")
                        local authcode = page:GetValue("get_mobile_code_text")

                        if not account or account == "" then
                            GameLogic.AddBBS(nil, L"请输入手机号码", 3000, "255 0 0", 21)
                            return false
                        end

                        if not authcode or authcode == "" then
                            GameLogic.AddBBS(nil, L"请输入验证码", 3000, "255 0 0", 21)
                            return false
                        end

                        if not agree then
                            GameLogic.AddBBS(nil, L"请同意用户协议", 3000, "255 0 0", 21)
                            return false
                        end

                        MainLogin:LoginAction()
                    end

                    local isClickedGetPhoneCaptcha = false

                    function get_mobile_code()   
                        if #page:GetValue("account") ~= 11 then
                            GameLogic.AddBBS(nil, L"手机号码位数不对", 3000, "255 0 0", 21)
                            return false
                        end

                        if page:GetValue("account") == "" then
                            GameLogic.AddBBS(nil, L"手机号码不能为空", 3000, "255 0 0", 21)
                            return false
                        end

                        if isClickedGetPhoneCaptcha then
                           return false 
                        end

                        isClickedGetPhoneCaptcha = true
                        
                        -- Mod.CodePku.MsgBox:Show(L"正在获取验证码...", 8000, L"链接超时", 300, 120)

                        local times = 60

                        local timer = commonlib.Timer:new({
                            callbackFunc = function(timer)
                                page:SetValue("get_mobile_code_text", format("%s(%ds)", L"重新发送", times))

                                if times == 0 then
                                    isClickedGetPhoneCaptcha = false
                                    page:SetValue("get_mobile_code_text", L"获取验证码")
                                    timer:Change(nil, nil)
                                end

                                times = times - 1
                            end
                        })

                        timer:Change(1000, 1000)

                        CodePkuServiceSession:getMobileCode(
                            page:GetValue("account"), 
                            function (response, err)
                                if err == 200 then  
                                    -- Mod.CodePku.MsgBox:Close()

                                    if Config.defaultEnv == Config.env.RELEASE then
                                        GameLogic.AddBBS(nil, L"验证码获取成功", 3000, "255 0 0", 21)
                                    else
                                        GameLogic.AddBBS(nil, L("验证码是："..response.data.code), 7000, "255 0 0", 21)
                                    end

                                    LOG.std(nil, "info", "codepku", "get mobile code success")
                                    local mobileToken = response.data.mobile_token
                                    page:SetValue('mobile_token', mobileToken)
                                else 
                                    local errMsg = response.message or "获取验证码失败"
                                    -- Mod.CodePku.MsgBox:Close()   
                                    GameLogic.AddBBS(nil, errMsg, 3000, "255 0 0", 21)
                                    isClickedGetPhoneCaptcha = false
                                end
                            end
                        )
                    end

                    function show_user_agreement()
                        MainLogin:ShowUserAgreementModal()
                    end
                ]]>
            </script>
            <style type="text/mcss">
                {
                    modal_title = {
                        ["font-size"] = 30,
                        ["base-font-size"] = 30,
                        ["font-weight"] = 'bold',
                        ["font-family"] = "Microsoft YaHei",
                        color = "#262014",
                        textcolor = "#262014",
                        ["margin-top"] = 12,
                        ["text-align"] = "center"
                    },
                    text_field = {
                        background = "textures/worldshare_32bits.png;72 20 16 16:3 3 3 3",
                        border = "none",
                        width = 434,
                        height = 52,
                        ["font-size"] = 19,
                        ["base-font-size"] = 19,
                        ["text-align"] = "left",
                        ["text-valign"] = "center"
                    },
                    get_code_divider = {
                        color =  "#40403f",
                        ["font-size"] = 24,
                        ["margin-left"] = -138,
                        ["margin-top"] = 7.2
                    },
                    get_code_button = {
                        width = 128,
                        height = 52,
                        color = "#40403f",
                        textcolor = "#40403f",
                        ["font-size"] = 19.2,
                        ["base-font-size"] = 19.2,
                        border = "none",
                        ["font-weight"] = "bold",
                        ["font-family"] = "Microsoft Yahei",
                        ["margin-top"] = -7.2,
                        background = "#ffffff"
                    },               
                    login_button = {
                        width = 434,
                        height = 52,
                        textcolor = "#ffffff",
                        color = "#ffffff",
                        ["font-size"] = 20.4,
                        ["font-weight"] = "bold",
                        ["font-family"] = "Microsoft Yahei",
                        background = "codepku/image/textures/login/button_login.png",
                    },
                    helper = {
                        color = '#ffffff',
                        ["font-size"] = 13.2,
                        ["margin-top"] = 10.8,
                        ["margin-bottom"] = 10.8
                    }
                }
            </style>
            <!-- <pe:container alignment="_ctt" ClickThrough="true" style="position:relative;width:370px;height:75px;margin-top:42px;background:;">
                <div style='<%="width:370px;height:75px;background:url(codepku/image/textures/login/mainlogin_32bits.png# 1071 233 616 125);"%>'></div>
            </pe:container> -->
            <pe:container alignment="_ct" ClickThrough="true" style="position:relative;margin-top:-140px;margin-left:-284px;width:568px;height:368px;background:url(codepku/image/textures/login/mainlogin_32bits.png# 20 71 944 614);">
                <div class="modal_title"><%= L"用户登录" %></div>
                <div style="position:relative;padding-top:28px;padding-left:64px;">
                    <div>
                        <input name="account" type="text" class="text_field" EmptyText='<%= L"请输入手机号码" %>' />
                        <div class="helper">若该手机未注册，我们会自动为您注册</div>
                    </div>
                    <div style="margin-bottom:18px;">
                        <input type="text" class="text_field" name="verify_code"  EmptyText='<%= L"请输入验证码" %>'/>
                        <span class="get_code_divider">|</span>
                        <input
                            type="button"
                            class="get_code_button"
                            DefaultButton="true"
                            name="get_mobile_code_text"
                            onclick="get_mobile_code()"
                            value='<%= L"获取验证码"%>' 
                        />
                        <input type="hidden" name="mobile_token"/>
                    </div>
                    <div>
                        <input type="button" DefaultButton="true" class="login_button" onclick="login()" value='<%= L"登 录"%>' />
                        <div class="helper" style="margin-left:111px;">
                            <input type="checkbox" name="agree" checked="checked" style="margin-right:7px; width:18px;height:18px;" />
                            <div style="float: right" onclick="show_user_agreement()">
                                <%= L"我已详细阅读并同意" %>
                                <div style="color:#6dd245;float: right"><%= L"《隐私政策》" %></div>
                            </div>
                        </div>
                    </div>
                </div>
            </pe:container>
        </pe:mcml>
    </body>
</html>