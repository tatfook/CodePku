<html>
    <head>
        <title>20200526</title>
    </head>
    <body>
        <pe:mcml>
            <script type="text/npl">
                <![CDATA[
                    NPL.load("(gl)script/apps/Aries/Creator/Game/Login/Rebranding.lua")
                    Rebranding = commonlib.gettable("MyCompany.Aries.Creator.Game.Rebranding")
                    local GameMainLogin = commonlib.gettable("MyCompany.Aries.Game.MainLogin")
                    local MainLogin = NPL.load("./MainLogin.lua")                                                            
                    local CodePkuServiceSession = NPL.load("(gl)Mod/CodePku/service/CodePkuService/Session.lua")

                    local page = document:GetPageCtrl()
                    Mod.CodePku.Store:Set("page/MainLogin", page)

                    function OnOpenModulePage()
                        NPL.load("(gl)script/apps/Aries/Creator/Game/Login/SelectModulePage.lua");
                        local SelectModulePage = commonlib.gettable("MyCompany.Aries.Game.MainLogin.SelectModulePage")
                        SelectModulePage.ShowPage()
                    end

                    function OnChangeLanguagePage()
                        NPL.load("(gl)script/apps/Aries/Creator/Game/Common/Translation.lua")

                        local Translation = commonlib.gettable("MyCompany.Aries.Game.Common.Translation")
                        Translation.ShowPage(function()
                            page:Refresh(0.01)
                        end)
                    end

                    function GetModDes()
                        local modname = ParaEngine.GetAppCommandLineByParam("mod","")
                        local s = string.format(L"当前Mod:%s",modname)
                        return s
                    end

                    function OnCustomCharacter()
                    end                                        
                        
                    function GetModCountAsString()
                        NPL.load("(gl)script/apps/Aries/Creator/Game/Mod/ModManager.lua")
                        local ModManager = commonlib.gettable("Mod.ModManager")
                        local pluginloader = ModManager:GetLoader()
                        local nCount = pluginloader:GetActiveModCount()

                        if nCount > 0 then
                            return format("(%d)", nCount)
                        else
                            return ""
                        end
                    end

                    function OnClickCustomerService()
                        ParaGlobal.ShellExecute("open", L"https://keepwork.com/official/docs/FAQ/questions", "", "", 1)
                    end

                    function login_text()
                        return Mod.CodePku.Store:Get("user/loginText")
                    end

                    function get_history_users()
                        return MainLogin:GetHistoryUsers()
                    end

                    function login()
                        local agree = page:GetValue("agree")
                        local account = page:GetValue("account")
                        local authcode = page:GetValue("get_mobile_code_text")

                        if not account or account == "" then
                            GameLogic.AddBBS(nil, L"请输入手机号码", 3000, "255 0 0")
                            return false
                        end

                        if not authcode or authcode == "" then
                            GameLogic.AddBBS(nil, L"请输入验证码", 3000, "255 0 0")
                            return false
                        end

                        if not agree then
                            GameLogic.AddBBS(nil, L"请同意用户协议", 3000, "255 0 0")
                            return false
                        end

                        MainLogin:LoginAction()
                    end

                    local isClickedGetPhoneCaptcha = false

                    function get_mobile_code()   
                        if #page:GetValue("account") ~= 11 then
                            GameLogic.AddBBS(nil, L"手机号码位数不对", 3000, "255 0 0")
                            return false
                        end

                        if page:GetValue("account") == "" then
                            GameLogic.AddBBS(nil, L"手机号码不能为空", 3000, "255 0 0")
                            return false
                        end

                        if isClickedGetPhoneCaptcha then
                           return false 
                        end

                        isClickedGetPhoneCaptcha = true
                        
                        Mod.CodePku.MsgBox:Show(L"正在获取验证码...", 8000, L"链接超时", 300, 120)

                        local times = 60

                        local timer = commonlib.Timer:new({
                            callbackFunc = function(timer)
                                page:SetValue("get_mobile_code_text", format("%s(%ds)", L"重新发送", times))

                                if times == 0 then
                                    isClickedGetPhoneCaptcha = false
                                    page:SetValue("get_mobile_code_text", L"获取验证码")
                                    timer:Change(nil, nil)
                                end

                                times = times - 1
                            end
                        })

                        timer:Change(1000, 1000)

                        CodePkuServiceSession:getMobileCode(
                            page:GetValue("account"), 
                            function (response, err)
                                if err == 200 then  
                                    Mod.CodePku.MsgBox:Close()       
                                    GameLogic.AddBBS(nil, L"验证码获取成功", 3000, "255 0 0")         
                                    LOG.std(nil, "info", "codepku", "get mobile code success")
                                    local mobileToken = response.data.mobile_token
                                    page:SetValue('mobile_token', mobileToken)
                                else 
                                    local errMsg = response.message or "获取验证码失败"
                                    Mod.CodePku.MsgBox:Close()   
                                    GameLogic.AddBBS(nil, errMsg, 3000, "255 0 0")
                                    isClickedGetPhoneCaptcha = false
                                end
                            end
                        )
                    end

                    function show_user_agreement()
                        MainLogin:ShowUserAgreementModal()
                    end
                ]]>
            </script>
            <style type="text/mcss">
                {
                    user_login = {
                        width = 362,
                        ["base-font-size"] = 16,
                        ["font-size"] = 16,
                        color = "#ffffff",
                        ["margin-left"] = -46,
                        ["margin-top"] = -22,
                        ["font-family"] = "Microsoft Yahei"
                    },
                    modal_title = {
                        ["font-size"] = 24,
                        ["base-font-size"] = 24,
                        ["font-weight"] = 'bold',
                        ["font-family"] = "Microsoft YaHei",
                        ["margin-left"] = 188,
                        ["margin-top"] = 8,
                        color = "#262014",
                        textcolor = "#262014",
                    },
                    text_field = {
                        background = "textures/worldshare_32bits.png;72 20 16 16:3 3 3 3",
                        border = "none",
                        width = 361,
                        height = 44,
                        ["font-size"] = 24,
                        ["base-font-size"] = 24
                    },
                    get_code_divider = {
                        color =  "#40403f",
                        ["font-size"] = 17,
                        ["margin-left"] = -126,
                        ["margin-top"] = 8
                    },
                    get_code_button = {
                        width = 110,
                        height = 42,
                        color = "#40403f",
                        textcolor = "#40403f",
                        ["font-size"] = 17,
                        background = '#ffffff',
                        border = "none",
                        ["border-left"] = "1px solid #40403f",
                        ["margin-top"] = -44,
                        ["margin-left"] = 244,
                        ["font-weight"] = "bold",
                        ["font-family"] = "Microsoft Yahei"
                    },               
                    login_button = {
                        ["margin-left"] = 0,
                        ["margin-bottom"] = 5,
                        width = 361,
                        height = 44,
                        textcolor = "#ffffff",
                        color = "#ffffff",
                        ["font-size"] = 18,
                        ["font-weight"] = "bold",
                        ["font-family"] = "Microsoft Yahei",
                        background = "textures/login/button-login.png",
                    },
                    helper = {
                        color = '#ffffff',
                        ["font-size"] = 12,
                        ["margin-top"] = 5,
                        ["margin-bottom"] = 6
                    }
                }
            </style>
            <pe:container alignment="_ctt" ClickThrough="true" style="position:relative;width:960px;height:64px;margin-top:60px;background:;">
                <div style='<%="position:relative;margin-left:326px;width:308px;height:63px;background:url(textures/login/mainlogin3_32bits.png# 1071 233 616 125);"%>'></div>
            </pe:container>
            <pe:container alignment="_ct" ClickThrough="true" style="position:relative;margin-top:-114px;margin-left:-236px;width:472px;height:307px;background:url(textures/login/mainlogin3_32bits.png# 20 71 944 614);">
                <div class="modal_title"><%= L"用户登录" %></div>
                <div style="position:relative;margin-left:100px;padding-top: 50px;">
                    <div name="login" class="user_login">
                        <pe:if condition="<%= login_text() ~= nil %>">
                            <div style="margin-bottom:15px;"><%= login_text()%></div>
                        </pe:if>
                        <div>
                            <input name="account" type="text" class="text_field" EmptyText='<%= L"请输入手机号码" %>' />
                            <div class="helper">若该手机未注册，我们会自动为您注册</div>
                        </div>
                        <div style="margin-bottom:12px;">
                            <!-- <div style="float:left;min-width:65px"><%= L"密码：" %></div> -->
                            <input type="text" class="text_field" name="verify_code"  EmptyText='<%= L"请输入验证码" %>'/>
                            <span class="get_code_divider">|</span>
                            <input
                                type="button"
                                class="get_code_button"
                                DefaultButton="true"
                                name="get_mobile_code_text"
                                onclick="get_mobile_code()"
                                value='<%= L"获取验证码"%>' 
                            />
                            <input type="hidden" name="mobile_token"/>
                        </div>
                        <div>
                            <input type="button" DefaultButton="true" class="login_button" onclick="login()" value='<%= L"登 录"%>' />
                            <div class="helper" style="margin-left: 80px">
                                <input type="checkbox" name="agree" checked="checked" style="margin: 2px 2px 0 0" />
                                <div style="float: right" onclick="show_user_agreement()">
                                    <%= L"我已详细阅读并同意" %>
                                    <div style="color:#6dd245;float: right"><%= L"《隐私政策》" %></div>
                                </div>
                            </div>
                        </div>                        
                    </div>
                </div>
            </pe:container>
        </pe:mcml>
    </body>
</html>