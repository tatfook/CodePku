<!-- "Mod/CodePku/cellar/Common/TouchMiniButtons/MainUIButtons_dialog.html" -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" >
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title></title>
</head>

<body>
<pe:mcml>
<script refresh="false" type="text/npl" src="MainSceneUIButtons.lua"><![CDATA[
MainSceneUIButtons = commonlib.gettable("Mod.CodePku.Common.TouchMiniButtons.MainSceneUIButtons");
DialogMessages = commonlib.gettable("Mod.CodePku.Common.MainUIButtons.DialogMessages")
local CodepkuChatChannel = NPL.load("(gl)Mod/CodePku/chat/CodepkuChatChannel.lua");

-- {"全部","世界","本地","公会","校园","系统","好友"}
Channels = {
    [1]={name="all_clicked",index=0},[2]={name="world",index=1},
    [3]={name="local",index=2},[4]={name="group",index=3},
    [5]={name="school",index=4},[6]={name="system",index=5},
    [7]={name="friends",index=6},
            }

LAST_CLICKED_INDEX = 1



function OnClose()
    Page:CloseWindow()
    MainSceneUIButtons.show_dialog_ui(false)
end

function OnClickChannel(index)
    index = index + 1
    if index ~= LAST_CLICKED_INDEX then
        Channels[LAST_CLICKED_INDEX].name = string.gsub(Channels[LAST_CLICKED_INDEX].name, '_clicked', '')
        LAST_CLICKED_INDEX = index
        Channels[LAST_CLICKED_INDEX].name = Channels[LAST_CLICKED_INDEX].name..'_clicked'
        Page:Refresh(0)
    end
end

function OnClickVoice()

end

function OnClickEmoji()

end

function OnClickSend()
    local page = document:GetPageCtrl()
    local words = page:GetValue("DialogContent")
    echo(string.format('DialogContent: %s', words))
    if LAST_CLICKED_INDEX == 2 then -- 世界
        CodepkuChatChannel.SendWorldMsg(words)
    elseif LAST_CLICKED_INDEX == 3 then -- 附近
        CodepkuChatChannel.SendNearByMsg(words)   
    end
    Page:Refresh(0.5)
end


function GetMessages()
    local Messages = {}
    if LAST_CLICKED_INDEX == 1 then
        Messages = CodepkuChatChannel.Messages
    else
        for i, v in ipairs(CodepkuChatChannel.Messages) do
            if v and v.channel == LAST_CLICKED_INDEX then
                table.insert(Messages, v)
            end
        end
    end
    return Messages
end


]]></script>
<style type="text/mcss">
</style>
<pe:container alignment="_ct" width="1000" height="1080">
    
    <div style="width:960;height:1080;background:url(codepku/image/textures/chat/chat_board.png);">
        <!-- 频道 -->
        <div style="width: 960;height: 100;">
            <pe:repeat DataSource="<%=Channels%>">
                <pe:repeatitem>
                    <div style="<%=format('width: 100;height:60;position:relative;left:%d;margin:20;background:url(codepku/image/textures/chat/%s.png)', Eval('index')*135, Eval('name'))%>" name="<%=Eval('index')%>" onclick="OnClickChannel"></div>
                </pe:repeatitem>
            </pe:repeat>
        </div>
        <!-- 显示栏 -->
        <div style="width: 960;height:850;">
            <pe:gridview style="width: 900; height: 800" name='messages' DataSource="<%=GetMessages()%>" DefaultNodeHeight = "120" ItemsPerLine="1" AllowPaging="false" RememberScrollPos="false" RememberLastPage="false" VerticalScrollBarStep="20">
                <Columns>
                    <pe:if condition="<%=Eval('speakerIsMe')==0%>">
                        <div style="width: 900;height: 150;margin-top: 30;">
                            <div style="width: 125;height: 125;background: url(codepku/image/textures/chat/icon_8.png);margin-left: 30px;">
                                <div style="<%=format('width: 110;height:110;margin:6;background: url(%s);', Eval('avatar'))%>"></div>
                                <div style="background: url(codepku/image/textures/chat/icon_5.png); width: 75;height: 25;position: absolute;margin-top:-25;margin-left: 50;font-size: 18px;color:white;text-align: center;"><%=format("等级%d", Eval("level"))%></div>
                            </div>
                            <div style="width: 500px;height: 30px;font-size: 30px;color: white;font-weight: bold;margin-left: 190px;margin-top: -130;"><%=Eval('nickname')%></div>
                            <div style="background: url(codepku/image/textures/chat/icon_3.png); width: 500px;height: 90px;margin-left: 180px;margin-top: -95px;font-size: 30px;padding-left: 30px;"><%=Eval('dialog')%></div>
                        </div>
                    </pe:if>
                    <pe:if condition="<%=Eval('speakerIsMe')==1%>">
                        <div style="width: 900;height: 150;margin-top: 30">
                            
                            <div style="width: 500px;height: 30px;font-size: 30px;color: white;font-weight: bold;margin-left: 220px;text-align: right;padding-right: 16px;margin-bottom: 10px;"><%=Eval('nickname')%></div>
                            <div style="background: url(codepku/image/textures/chat/icon_4.png); width: 500px;height: 90px;margin-left: 220px;font-size: 30px;padding-left: 20px;"><%=Eval('dialog')%></div>
                            <div style="width: 125;height: 125;background: url(codepku/image/textures/chat/icon_8.png);margin-left: 750px;margin-top:-120">
                                <div style="<%=format('width: 110;height:110;margin:6;background: url(%s);', Eval('avatar'))%>"></div>
                                <div style="background: url(codepku/image/textures/chat/icon_5.png); width: 75;height: 25;position: absolute;margin-top:-25;margin-left: 50;font-size: 18px;color:white;text-align: center;"><%=format("等级%d", Eval("level"))%></div>
                            </div>
                        </div>
                    </pe:if>
                    
                </Columns>
            </pe:gridview>
        </div>
        <!-- 发言 -->
        <div style='width: 960;height:130'>
            <div style='width: 600;height:50;margin-top: 40%;background: url(codepku/image/textures/chat/icon_6.png);margin-left: 40px;'>
                <input type="text" style='width:600;height: 50;background-color: white;font-size: 28px;' name='DialogContent'/>
            </div>
            <div style='width:50;height:50;background: url(codepku/image/textures/chat/icon_2.png);margin-top: -50;margin-left: 660px;' onclick="OnClickVoice"></div>
            <div style='width:50;height:50;background: url(codepku/image/textures/chat/icon_1.png);margin-top:-50;margin-left: 730px' onclick="OnClickEmoji"></div>
            <div style='width:100;height:50;background: url(codepku/image/textures/chat/icon_7.png);margin-top:-50;margin-left: 800px' onclick="OnClickSend"></div>
        </div>
    </div>
    <div style="width: 40;height:100;background:url(codepku/image/textures/chat/icon_29.png);margin-left: 960;margin-top: -600;" onclick="OnClose"></div>
</pe:container>
</pe:mcml> 
</body>
</html>