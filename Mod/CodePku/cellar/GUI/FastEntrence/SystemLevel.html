<!-- "script/apps/Aries/Creator/Game/Areas/SystemEntrencePage.html" -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title></title>
</head>
<body>
    <pe:mcml onloadscript="script/apps/Aries/app_main.lua" callbackfunction="MyCompany.Aries.MSGProc">
<script refresh="false" type="text/npl" src="SystemEntrence.lua"><![CDATA[
GameLogic = commonlib.gettable("MyCompany.Aries.Game.GameLogic")
SystemEntrencePage = commonlib.gettable("Mod.CodePku.SystemEntrencePage");
SystemLevelPage = commonlib.gettable("Mod.CodePku.SystemLevelPage");
MainEntrencePage = commonlib.gettable("Mod.CodePku.MainEntrencePage");
SystemEntranceChoosePage = commonlib.gettable("Mod.CodePku.SystemEntranceChoosePage");
local MainPopup = commonlib.gettable("Mod.CodePku.GUI.MainPopup");


function ClosePage()
    Page:CloseWindow();
end

function OnClose()
    ClosePage()
end

function GetSubjects()
    return SystemLevelPage.subjects
end

function OnClickSubject(name)
    if SystemLevelPage.last_clicked_index ~= name then
        SystemLevelPage.subjects[name].title = SystemLevelPage.subjects[name].title..'_clicked'
        SystemLevelPage.subjects[SystemLevelPage.last_clicked_index].title = string.gsub(SystemLevelPage.subjects[SystemLevelPage.last_clicked_index].title, '_clicked', '')
        SystemLevelPage.last_clicked_index = name
        SystemLevelPage.courses = SystemLevelPage.GetLevels(SystemLevelPage.grade_id,SystemLevelPage.semester_id,SystemLevelPage.subjects[SystemLevelPage.last_clicked_index].subject_id)
        Page:Refresh(0)
    end
end

function GetLevels(grade_id, semester_id, subject_id)
    response = request:get(string.format('/coursewares/entrance/system?grade=%d&semester=%d&subject=%d&', grade_id, semester_id, subject_id),nil,{sync = sync})
    if response.code == 200 then
        return response.data
    end
end

function GetCourseName(course_wares)
    return course_wares.name
end

function GetCourseCover(course_wares)
    return course_wares.cover
end

function GetCourseWorldID(course_wares)
    return course_wares.keepwork_project_id
end

function GetDivisible(index)
    if index % 5 == 0 then
        return index / 5
    else
        return index/5
    end
end


function prev_page()
    if SystemLevelPage~=nil then
        if (SystemLevelPage.page > 1) then
            SystemLevelPage.page = SystemLevelPage.page - 1
            SystemLevelPage.courses = SystemLevelPage.GetLevels(SystemLevelPage.grade_id,SystemLevelPage.semester_id,SystemLevelPage.subjects[SystemLevelPage.last_clicked_index].subject_id)
            Page:Refresh(0)
        end
    end
end

function next_page()
    if SystemLevelPage~=nil then
        if (SystemLevelPage.page < SystemLevelPage.total_courses%10) then
        SystemLevelPage.page = SystemLevelPage.page + 1
            SystemLevelPage.courses = SystemLevelPage.GetLevels(SystemLevelPage.grade_id,SystemLevelPage.semester_id,SystemLevelPage.subjects[SystemLevelPage.last_clicked_index].subject_id)
            Page:Refresh(0)
        end
    end
end

function OnClickCourse(course)
    MainPopup:ShowPage("TPpopup", GetCourseName(course), GetCourseWorldID(course))
end

]]></script>
<style type="text/mcss">
</style>

    <div style="margin-top:5px;width:1920;height: 1080;background:url(codepku/image/textures/fastentrence/system_level_board.png)">
        <div style='width:100px;height:100px;background:url(codepku/image/textures/fastentrence/return.png);margin-left: 100px;margin-top: 20px;' onclick="OnClose"></div>
        <div style="width:200;height:900;margin-left: 20px;margin-top:70px;">
            <pe:repeat DataSource="<%=GetSubjects()%>">
                <pe:repeatitem>
                    <pe:if condition='<%=Eval("show")==true%>'>
                        <div style="<%=format('background:url(codepku/image/textures/fastentrence/system/%s.png);width:220;height:100;positionï¼šrelative', Eval('title'))%>" name='<%=Eval("index")%>' onclick='OnClickSubject'></div>
                    </pe:if>
                </pe:repeatitem>
            </pe:repeat>
        </div>
        <div style="width:1500;height:600;margin-left: 310px;margin-top:-800px">
            <pe:repeat DataSource="<%=SystemLevelPage.courses%>">
                <pe:repeatitem>
                    <div style="<%=format('position:absolute;width:290px;height:100;background:url(codepku/image/textures/fastentrence/system_level_1.png);margin-left:%d;margin-top:%d;base-font-size:28px;font-size:28px;text-align: center;', Eval('index')%5*310, GetDivisible(Eval('index'))*300-Eval('index')%5*60)%>"><div style="margin-top:35px"><%= GetCourseName(Eval('course')) %></div></div>
                    <div style="<%=format('position:absolute;width:290px;height:200;background:url(codepku/image/textures/fastentrence/system_level_2.png);margin-left:%d;margin-top:%d;', Eval('index')%5*310, 100+GetDivisible(Eval('index'))*300-Eval('index')%5*60)%>">
                        <div style="<%=format('width:290px;height:200;background:url(%s);', Eval('cover'))%>" name="<%=Eval('course')%>" onclick="OnClickCourse">
                            <%=Eval('course')%>
                        </div>
                    </div>
                </pe:repeatitem>
            </pe:repeat>
        </div>
        <div style='width:800;height:100;margin-left:600;margin-top:-150;'></div>
            <div style='width:75;height:75;margin-left:900;margin-top:-125;background:url(codepku/image/textures/fastentrence/prev.png);' onclick="prev_page"></div>
            <div style='base_font_size:40px;font-size:40px;margin-left: 1000;margin-top:-110;'><%=SystemLevelPage.page%></div>
            <div style='width:75;height:75;margin-left: 1050;margin-top:-125;background:url(codepku/image/textures/fastentrence/next.png);' onclick="next_page"></div>
        </div>
    </div>

</pe:mcml>
</body>
</html>

