<!-- "script/apps/Aries/Creator/Game/Areas/SystemEntrencePage.html" -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title></title>
</head>
<body>
    <pe:mcml onloadscript="script/apps/Aries/app_main.lua" callbackfunction="MyCompany.Aries.MSGProc">
<script refresh="false" type="text/npl" src="TopicEntrence.lua"><![CDATA[
    TopicEntrencePage = commonlib.gettable("MyCompany.Aries.Creator.Game.Desktop.TopicEntrencePage");
    MainEntrencePage = commonlib.gettable("MyCompany.Aries.Creator.Game.Desktop.MainEntrencePage");

    
    local page = document:GetPageCtrl()
    local last_clicked_index = 1
    local page_num = 1
    local select_button_clicked = 0
    local show_flag = 0
    
    
    local navig = {
        [1] = {name="古诗", title="gushi", index=1},
        [2] = {name="文章", title="wenzhang", index=2},
        [3] = {name="诗词", title="shici", index=3},
        [4] = {name="名言", title="mingyan", index=4},
        [5] = {name="其他", title="qita", index=5},
    }
    local select_method = {
        ['默认排序'] = 'default_select',
        ['ID'] = 'ID_select',
        ['热度'] = 'hot_select',
        ['人数'] = 'pepole_select'
    }

    function get_full_course()
        course = TopicEntrencePage.GetCourse(TopicEntrencePage.subjects[last_clicked_index].subject_id)
        return course
    end

    local topic_course = get_full_course()

    function ClosePage()
        Page:CloseWindow();
    end
    
    function OnClose()
        ClosePage()
        MainEntrencePage:ShowPage()
    end
    
    function GetSubjects()
        return TopicEntrencePage.subjects
    end
    
    function GetNavig()
        return navig
    end
    
    function SelectIsClicked()
        return select_button_clicked
    end
    
    function GetPageNum()
        return page_num
    end
    
    function get_searchByName_table()
        search_course = {}
        local i = 1
        --searchByName = page:GetValue("searchByName")
        for k, v in pairs(topic_course) do
            if(v.name == TopicEntrencePage.searchByName) then
                search_course[i] = v;
                search_course[i].index = (i-1) % 10
                i = i+1
            end
        end
        return search_course
    end
    
    function f_searchByName()
        searchByName = page:GetValue("searchByName")
        TopicEntrencePage.searchByName = searchByName
        if searchByName == "" then
            show_flag = 0
            page:SetValue("searchByName",'')
        else
            show_flag = 1
            page:SetValue("searchByName",searchByName)
        end
        Page:Refresh(0)
    end
    
    function sort_course(course, sort_method)
        local sort_course = commonlib.deepcopy(course)
        if sort_method == 'default_select' then
            sort_course = course
        elseif sort_method == 'ID_select' then
            table.sort(sort_course, function(a, b)
                return a.id > b.id
            end)
        end
        local i = 0
        for k, v in pairs(sort_course) do
            v.index = i%10
            i = i + 1
        end
        return sort_course
    end
    
    function OnIsClickedSelect()
        if select_button_clicked == 1 then
            select_button_clicked = 0
        else
            select_button_clicked = 1
        end
        Page:Refresh(0.01)
    end
    
    function OnSelectedItem(name)
        select_button_clicked = 0
        if name == 'default_select' then
            TopicEntrencePage.sortMethod = '默认排序'
        elseif name == 'ID_select' then
            TopicEntrencePage.sortMethod = 'ID'
        else
            GameLogic.RunCommand("/tip -duration 1500 功能开发中，敬请期待")
        end
        Page:Refresh(0.01)
    end
    
    function GetConditionalCourse()
        local conditional_course = {}
        if show_flag == 0 then
            conditional_course = sort_course(topic_course, select_method[TopicEntrencePage.sortMethod])
        else
            conditional_course = get_searchByName_table()
        end
        return conditional_course
    end
    
    function get_topic_course(conditional_course)
        page_course = {}
        num = (page_num - 1)*10
        for i = 1, 10 do
            if num + i <= #conditional_course then
                page_course[i] = conditional_course[num+i]
            else
                break
            end
        end
        return page_course
    end
    
    function OnClickSubject(name)
        if last_clicked_index ~= name then
            TopicEntrencePage.subjects[name].title = TopicEntrencePage.subjects[name].title..'_clicked'
            TopicEntrencePage.subjects[last_clicked_index].title = string.gsub(TopicEntrencePage.subjects[last_clicked_index].title, '_clicked', '')
            last_clicked_index = name
            topic_course = get_full_course()
            Page:Refresh(0)
        end
    end
    
    function ChangeTopicPage(name)
        if name == 'page_left' and page_num > 1 then
            page_num = page_num - 1
            Page:Refresh(0)
        elseif name == 'page_right' and #topic_course > page_num*10 then
            page_num = page_num + 1
            Page:Refresh(0)
        end
    end
    
    function OnClickNavig(name)
    end


    function OnClickCourse(name)
        local l = {}
        for a in string.gmatch(name, '%d') do
            table.insert(l, a)
        end
        is_open = l[2]
        if is_open == 1 then
            world_id = l[1]
            GameLogic.RunCommand(string.format("/connectCodePku %d", name));
            Page:CloseWindow()
        else
            GameLogic.RunCommand("/tip -duration 1500 该课程暂未开放，敬请期待")
        end
    end

    function GetDivisible(index)
        if index % 5 == 0 then
            return index / 5
        else
            return index/5
        end
    end


]]></script>
<style type="text/mcss">
</style>
<pe:if condition='<%=SelectIsClicked() == 1 %>' >
    <div style="width: 240px; height: 120px; position: absolute; z-index: 10; margin-left: 1648px; margin-top: 248px;">
        <div style="width: 240px; height: 50px; margin-top: 2px; background: url(codepku/image/textures/fastentrence/topic/default_select.png);" name="default_select" onclick="OnSelectedItem"></div>
        <div style="width: 240px; height: 50px; margin-top: 2px; background: url(codepku/image/textures/fastentrence/topic/ID_select.png);" name="ID_select" onclick="OnSelectedItem"></div>
        <!-- <div style="width: 240px; height: 50px; margin-top: 2px; background: url(codepku/image/textures/fastentrence/topic/hot_select.png);" name="hot_select" onclick="OnSelectedItem"></div> -->
        <!-- <div style="width: 240px; height: 50px; margin-top: 2px; background: url(codepku/image/textures/fastentrence/topic/people_select.png);" name="people_select" onclick="OnSelectedItem"></div> -->
    </div>
</pe:if>
<div style="margin-top:5px;width:1920;height: 1080;background:url(codepku/image/textures/fastentrence/topic_board.png);">
    <div style='width:100px;height:100px;background:url(codepku/image/textures/fastentrence/return.png);margin-left: 100px;margin-top: 20px;' onclick="OnClose"></div>
    <div style="width:200px;height:900px;margin-left: 20px;margin-right: 20px;margin-top:70px;float: left;">
        <pe:repeat DataSource="<%=GetSubjects()%>">
            <pe:repeatitem>
                <pe:if condition="<%=Eval('show')==true%>">
                    <div style="<%=format('background:url(codepku/image/textures/fastentrence/topic/%s.png);width:220;height:100;margin-left:-18;margin-bottom: 30;', Eval('title'))%>" name='<%=Eval("index")%>' onclick='OnClickSubject'></div>
                </pe:if>  
            </pe:repeatitem>
        </pe:repeat>
    </div>
    <div style="width:1650px;height:770px;margin-left: 20px;margin-top:50px;float: left;">
        <div style="width: 1630px;height: 100px;">
            <!--搜索-->
            <div style="width: 340px; height: 65px; margin-left: 1008px; float: left;">
                <input name="searchByName" type="text" style="width: 266px; height: 62px; background-color: #4BB7FD; font-size: 42px; float: left;" value="<%=TopicEntrencePage.searchByName%>"/>
                <div style="width: 72px; height: 62px; float: left;" onclick="f_searchByName">
                    <div style="width: 40px; height: 40px;margin-left: 30px;margin-top: 10px; background:url(codepku/image/textures/fastentrence/topic/search.png);"></div>
                </div>
            </div>

            <!--选择框-->
            <div style="width: 240px;height: 500px; margin-left: 40px; float: left;">
                <div style="width: 245px;height: 60px;">
                    <input type="text" style="width:175px; height:62px; font-size: 35px;background-color: #4BB7FD;" name="sort_input" value="<%=TopicEntrencePage.sortMethod%>"/>
                    <div style="width: 70px; height: 62px; float: left;"  onclick="OnIsClickedSelect">
                        <div style="width: 30px; height: 30px;margin-left: 30px;margin-top: 15px; background:url(codepku/image/textures/fastentrence/topic/sort.png); float: left;"></div>
                    </div>
                </div>
            </div>
        </div>
        <div style="width: 1630px;height: 675px;">
            <pe:repeat DataSource="<%=get_topic_course(GetConditionalCourse())%>">
                <pe:repeatitem>
                    <div style="<%=format('position:absolute; z-index: 5; width:290px;height:100;background:url(codepku/image/textures/fastentrence/system_level_1.png);margin-left:%d;margin-top:%d;base-font-size:28px;font-size:28px;text-align: center;', Eval('index')%5*310+20, 20+GetDivisible(Eval('index'))*300-Eval('index')%5*60)%>"><div style="margin-top:35px"><%= Eval('name') %></div></div>
                    <div style="<%=format('position:absolute; z-index: 5; width:290px;height:200;background:url(codepku/image/textures/fastentrence/system_level_2.png);margin-left:%d;margin-top:%d;', Eval('index')%5*310+20, 120+GetDivisible(Eval('index'))*300-Eval('index')%5*60)%>">
                        <div style="<%=format('width:290px;height:200;background:url(%s);', Eval('img'))%>" name="<%=format('%d %d', Eval('id'), Eval('is_open'))%>" onclick="OnClickCourse"></div>
                    </div>
                </pe:repeatitem>
            </pe:repeat>
        </div>
        <!--翻页-->
        <div style="width: 1630px; height: 50px;margin-left: 740px; float: left;">
            <div style="width: 50px; height: 50px;float: left; background: url(codepku/image/textures/fastentrence/topic/page_left.png);" name="page_left" onclick="ChangeTopicPage"></div>
            <div style="width: 50px;height: 50px;font-size: 40px;color: #ffffff;float: left; text-align: center; line-height: 40px;"><%=GetPageNum()%></div>
            <div style="width: 50px; height: 50px;float: left; background: url(codepku/image/textures/fastentrence/topic/page_right.png);" name="page_right" onclick="ChangeTopicPage"></div>
        </div>
    </div>
</div>
</pe:mcml>
</body>
</html>
